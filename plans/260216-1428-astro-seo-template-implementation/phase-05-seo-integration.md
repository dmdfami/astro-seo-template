# Phase 5: SEO Integration

**Priority:** P1 | **Status:** ✅ completed | **Effort:** 4h

## Context Links

- **Phase 4**: [Page Templates](phase-04-page-templates.md)
- **Research**: [Premium Template Research](../reports/researcher-260216-1414-astro-premium-template-research.md)

## Overview

Complete SEO stack: finalize SchemaRenderer (if not done in Phase 4), OpenGraph meta tags, XML sitemap, robots.txt, canonical URLs, meta descriptions. Integrate Pagefind for search indexing. Ensure all pages optimized for search engines.

## Key Insights

- SchemaRenderer already created in Phase 4 (Tier 2 auto-generation)
- OpenGraph component generates OG tags from frontmatter
- Astro sitemap integration auto-generates sitemap-index.xml
- Pagefind already configured in astro.config.mjs (Phase 1)
- All pages need canonical URLs to prevent duplicate content
- Meta descriptions max 160 chars, titles max 60 chars

## Requirements

### Functional
- OpenGraph meta tags on all pages
- Twitter Card tags
- Canonical URLs
- XML sitemap (auto-generated)
- robots.txt (already created in Phase 1, update if needed)
- Pagefind search index
- Alt tags on all images
- Structured data validation

### Non-Functional
- Meta titles < 60 chars
- Meta descriptions < 160 chars
- Images have width/height attributes
- All links have descriptive text
- No broken internal links

## Architecture

```
SEO Layer:
├── OpenGraph.astro          ← OG tags component
├── SchemaRenderer.astro     ← Already created in Phase 4
├── sitemap-index.xml        ← Auto-generated by @astrojs/sitemap
├── robots.txt               ← Already in public/ from Phase 1
├── Canonical URL            ← Added to BaseLayout
└── Pagefind index           ← Auto-built during build
```

## Related Code Files

### To Create
- `/Users/david/projects/astro-seo-template/src/components/seo/OpenGraph.astro`
- `/Users/david/projects/astro-seo-template/src/lib/seo-utils.ts`

### To Modify
- `/Users/david/projects/astro-seo-template/src/layouts/BaseLayout.astro` (add OpenGraph, canonical)
- `/Users/david/projects/astro-seo-template/astro.config.mjs` (add @astrojs/sitemap)
- `/Users/david/projects/astro-seo-template/public/robots.txt` (update sitemap URL)

## Implementation Steps

### 1. Install Sitemap Integration

```bash
npm install @astrojs/sitemap
```

### 2. Update astro.config.mjs

```javascript
// astro.config.mjs
import { defineConfig } from 'astro/config';
import tailwindcss from '@tailwindcss/vite';
import AutoImport from 'astro-auto-import';
import mdx from '@astrojs/mdx';
import pagefind from 'astro-pagefind';
import sitemap from '@astrojs/sitemap';

export default defineConfig({
  site: 'https://example.com', // IMPORTANT: Set actual domain
  vite: {
    plugins: [tailwindcss()],
  },
  integrations: [
    AutoImport({
      imports: [
        // ... all 51 components from Phase 3
      ],
    }),
    mdx(),
    sitemap({
      filter: (page) => !page.includes('/draft/'),
      changefreq: 'weekly',
      priority: 0.7,
      lastmod: new Date(),
    }),
    pagefind(), // MUST be last
  ],
});
```

### 3. Create SEO Utils

```typescript
// src/lib/seo-utils.ts
export function truncate(text: string, maxLength: number): string {
  if (text.length <= maxLength) return text;
  return text.slice(0, maxLength - 3) + '...';
}

export function generateMetaTitle(title: string, siteName: string): string {
  const fullTitle = title === siteName ? title : `${title} | ${siteName}`;
  return truncate(fullTitle, 60);
}

export function generateMetaDescription(description: string): string {
  return truncate(description, 160);
}

export function getCanonicalURL(path: string, site: string): string {
  const cleanPath = path.replace(/\/$/, '');
  const cleanSite = site.replace(/\/$/, '');
  return cleanPath === '' ? cleanSite : `${cleanSite}${cleanPath}`;
}

export function getOpenGraphImageURL(image: string | undefined, site: string): string {
  if (!image) return `${site}/images/og-default.jpg`;
  if (image.startsWith('http')) return image;
  return `${site}${image}`;
}
```

### 4. Create OpenGraph Component

```astro
---
// src/components/seo/OpenGraph.astro
import siteConfig from '../../../site-config.json';
import {
  generateMetaTitle,
  generateMetaDescription,
  getCanonicalURL,
  getOpenGraphImageURL
} from '@lib/seo-utils';

interface Props {
  title: string;
  description: string;
  image?: string;
  type?: 'website' | 'article' | 'product';
  publishedTime?: Date;
  modifiedTime?: Date;
  author?: string;
  tags?: string[];
}

const {
  title,
  description,
  image,
  type = 'website',
  publishedTime,
  modifiedTime,
  author,
  tags = []
} = Astro.props;

const metaTitle = generateMetaTitle(title, siteConfig.site.name);
const metaDescription = generateMetaDescription(description);
const canonicalURL = getCanonicalURL(Astro.url.pathname, siteConfig.site.url);
const ogImage = getOpenGraphImageURL(image, siteConfig.site.url);
---

<!-- Primary Meta Tags -->
<title>{metaTitle}</title>
<meta name="title" content={metaTitle} />
<meta name="description" content={metaDescription} />
<link rel="canonical" href={canonicalURL} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type} />
<meta property="og:url" content={canonicalURL} />
<meta property="og:title" content={metaTitle} />
<meta property="og:description" content={metaDescription} />
<meta property="og:image" content={ogImage} />
<meta property="og:site_name" content={siteConfig.site.name} />

{type === 'article' && publishedTime && (
  <meta property="article:published_time" content={publishedTime.toISOString()} />
)}
{type === 'article' && modifiedTime && (
  <meta property="article:modified_time" content={modifiedTime.toISOString()} />
)}
{type === 'article' && author && (
  <meta property="article:author" content={author} />
)}
{type === 'article' && tags.map(tag => (
  <meta property="article:tag" content={tag} />
))}

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={canonicalURL} />
<meta property="twitter:title" content={metaTitle} />
<meta property="twitter:description" content={metaDescription} />
<meta property="twitter:image" content={ogImage} />
{siteConfig.social.twitter && (
  <meta property="twitter:site" content={siteConfig.social.twitter.replace('https://twitter.com/', '@')} />
)}

<!-- Additional SEO -->
<meta name="robots" content="index, follow" />
<meta name="language" content={siteConfig.site.language} />
<meta name="author" content={author || siteConfig.site.name} />

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
```

### 5. Update BaseLayout with OpenGraph

```astro
---
// src/layouts/BaseLayout.astro (UPDATE)
import '../styles/global.css';
import { ClientRouter } from 'astro:transitions';
import schemaOrg from '../../schema-org.json';
import OpenGraph from '@components/seo/OpenGraph.astro';

interface Props {
  title: string;
  description: string;
  image?: string;
  type?: 'website' | 'article' | 'product';
  publishedTime?: Date;
  modifiedTime?: Date;
  author?: string;
  tags?: string[];
}

const {
  title,
  description,
  image,
  type = 'website',
  publishedTime,
  modifiedTime,
  author,
  tags
} = Astro.props;

const orgSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  name: schemaOrg.organization.name,
  url: schemaOrg.organization.url,
  logo: schemaOrg.organization.logo,
  sameAs: schemaOrg.organization.sameAs,
  contactPoint: schemaOrg.organization.contactPoint,
};

const siteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: schemaOrg.website.name,
  url: schemaOrg.website.url,
};
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Client Router for View Transitions -->
  <ClientRouter />

  <!-- OpenGraph + Meta Tags -->
  <OpenGraph
    title={title}
    description={description}
    image={image}
    type={type}
    publishedTime={publishedTime}
    modifiedTime={modifiedTime}
    author={author}
    tags={tags}
  />

  <!-- Dark mode script (inline to prevent FOUC) -->
  <script is:inline>
    (function() {
      const theme = localStorage.getItem('theme');
      if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      }
    })();
  </script>

  <!-- Re-apply dark mode after view transition -->
  <script is:inline>
    document.addEventListener('astro:after-swap', () => {
      const theme = localStorage.getItem('theme');
      if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });
  </script>

  <!-- Schema.org Tier 1: Organization + WebSite -->
  <script type="application/ld+json" set:html={JSON.stringify(orgSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(siteSchema)} />

  <!-- Tier 2 schemas injected here -->
  <slot name="schema" />

  <slot name="head" />
</head>
<body>
  <slot />
</body>
</html>
```

### 6. Update Blog Post Template with SEO Props

```astro
---
// src/pages/blog/[slug].astro (UPDATE head section)
// ... existing imports ...

// Add to BaseLayout props:
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  image={post.data.image?.src}
  type="article"
  publishedTime={post.data.publishDate}
  modifiedTime={post.data.updatedDate}
  author={post.data.author}
  tags={post.data.tags}
>
  <!-- ... rest of template ... -->
</BaseLayout>
```

### 7. Update Product Page Template with SEO Props

```astro
---
// src/pages/products/[slug].astro (UPDATE)
// ... existing imports ...
---

<BaseLayout
  title={product.data.title}
  description={product.data.description}
  image={product.data.image?.src}
  type="product"
>
  <!-- ... rest of template ... -->
</BaseLayout>
```

### 8. Update robots.txt

```txt
# /public/robots.txt (UPDATE)
User-agent: *
Allow: /

# Disallow draft content
Disallow: /draft/

# Sitemaps
Sitemap: https://example.com/sitemap-index.xml
```

### 9. Add Image Optimization Check Script

```typescript
// src/lib/image-check.ts
export function validateImageAlt(images: NodeListOf<HTMLImageElement>): void {
  images.forEach(img => {
    if (!img.alt && !img.getAttribute('aria-hidden')) {
      console.warn(`Missing alt text: ${img.src}`);
    }
  });
}

export function validateImageDimensions(images: NodeListOf<HTMLImageElement>): void {
  images.forEach(img => {
    if (!img.width || !img.height) {
      console.warn(`Missing dimensions: ${img.src}`);
    }
  });
}
```

### 10. Create SEO Checklist Component (Dev Tool)

```astro
---
// src/components/seo/SEOChecklist.astro
// Only rendered in dev mode
const isDev = import.meta.env.DEV;
---

{isDev && (
  <div class="fixed bottom-4 left-4 z-50 bg-yellow-100 border-2 border-yellow-400 rounded-lg p-4 max-w-sm">
    <h3 class="font-bold text-yellow-900 mb-2">SEO Checklist</h3>
    <ul class="text-sm text-yellow-800 space-y-1">
      <li>✓ Meta title &lt; 60 chars</li>
      <li>✓ Meta description &lt; 160 chars</li>
      <li>✓ Canonical URL set</li>
      <li>✓ OG image present</li>
      <li>✓ Schema.org markup</li>
      <li>✓ Alt tags on images</li>
      <li>✓ H1 present (only one)</li>
      <li>✓ Internal links descriptive</li>
    </ul>
    <button
      onclick="this.parentElement.remove()"
      class="mt-2 text-xs text-yellow-600 hover:text-yellow-900"
    >
      Close
    </button>
  </div>
)}
```

### 11. Add Structured Data Testing Script

```bash
# package.json - add test script
npm pkg set scripts.test:schema="node scripts/validate-schema.mjs"
```

```javascript
// scripts/validate-schema.mjs
import { readFileSync, readdirSync } from 'fs';
import { join } from 'path';

const distDir = './dist';

function extractSchemas(html) {
  const regex = /<script type="application\/ld\+json">(.*?)<\/script>/gs;
  const matches = [...html.matchAll(regex)];
  return matches.map(m => {
    try {
      return JSON.parse(m[1].trim());
    } catch (e) {
      return null;
    }
  }).filter(Boolean);
}

function validateSchema(schema) {
  const errors = [];

  if (!schema['@context']) errors.push('Missing @context');
  if (!schema['@type']) errors.push('Missing @type');

  // Type-specific validation
  if (schema['@type'] === 'Article') {
    if (!schema.headline) errors.push('Article missing headline');
    if (!schema.datePublished) errors.push('Article missing datePublished');
    if (!schema.author) errors.push('Article missing author');
  }

  if (schema['@type'] === 'Product') {
    if (!schema.name) errors.push('Product missing name');
    if (!schema.description) errors.push('Product missing description');
  }

  return errors;
}

function scanHTMLFiles(dir) {
  const files = readdirSync(dir, { recursive: true, withFileTypes: true });
  let totalSchemas = 0;
  let totalErrors = 0;

  files.forEach(file => {
    if (file.isFile() && file.name.endsWith('.html')) {
      const filePath = join(file.path, file.name);
      const html = readFileSync(filePath, 'utf-8');
      const schemas = extractSchemas(html);

      schemas.forEach(schema => {
        totalSchemas++;
        const errors = validateSchema(schema);
        if (errors.length > 0) {
          console.log(`\n❌ ${filePath}`);
          console.log(`   Type: ${schema['@type']}`);
          errors.forEach(err => console.log(`   - ${err}`));
          totalErrors += errors.length;
        }
      });
    }
  });

  console.log(`\n✅ Scanned ${totalSchemas} schemas, found ${totalErrors} errors`);
  if (totalErrors > 0) process.exit(1);
}

scanHTMLFiles(distDir);
```

### 12. Create OG Image Default

Create placeholder at `/public/images/og-default.jpg` (1200x630px).

Or use dynamic OG image generation (optional, future enhancement):

```typescript
// Future: src/pages/og/[slug].png.ts
// Use @vercel/og or similar to generate dynamic OG images
```

## Todo List

- [ ] Install `@astrojs/sitemap` package
- [ ] Update `astro.config.mjs` with sitemap integration and site URL
- [ ] Create `src/lib/seo-utils.ts` with meta helpers
- [ ] Create `src/components/seo/OpenGraph.astro` component
- [ ] Update `src/layouts/BaseLayout.astro` with OpenGraph component
- [ ] Update blog post template with SEO props (type, publishedTime, etc.)
- [ ] Update product page template with SEO props
- [ ] Update `public/robots.txt` with sitemap URL
- [ ] Create `src/lib/image-check.ts` validation utilities
- [ ] Create `scripts/validate-schema.mjs` for testing
- [ ] Add `test:schema` script to package.json
- [ ] Create placeholder OG image at `public/images/og-default.jpg`
- [ ] Create `public/favicon.svg` and `public/apple-touch-icon.png`
- [ ] Test sitemap generates at `/sitemap-index.xml`
- [ ] Verify robots.txt accessible at `/robots.txt`
- [ ] Test OpenGraph tags render on all page types
- [ ] Run schema validation script (`npm run test:schema`)
- [ ] Test Twitter Card validator (https://cards-dev.twitter.com/validator)
- [ ] Test Facebook debugger (https://developers.facebook.com/tools/debug/)
- [ ] Test Google Rich Results (https://search.google.com/test/rich-results)
- [ ] Verify canonical URLs are absolute
- [ ] Check all images have alt tags
- [ ] Verify meta descriptions < 160 chars on all pages
- [ ] Test Pagefind search indexes content correctly
- [ ] Run Lighthouse SEO audit (target 100)

## Success Criteria

- Sitemap auto-generated at build (`/sitemap-index.xml`)
- robots.txt accessible and points to sitemap
- All pages have OpenGraph tags (OG title, description, image, type)
- Twitter Cards render correctly in validator
- Schema.org validation passes (zero errors)
- All images have alt text or aria-hidden
- Canonical URLs present on all pages
- Meta titles < 60 chars, descriptions < 160 chars
- Pagefind search works and returns results
- Lighthouse SEO score 100

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Sitemap includes draft pages | Medium | Use sitemap filter to exclude /draft/ paths |
| Missing OG images cause broken previews | Medium | Default fallback image in OpenGraph component |
| Schema validation errors | High | Automated test script, manual validation |
| Canonical URL mismatch | Medium | Use Astro.site + Astro.url.pathname consistently |
| Meta descriptions too long | Low | Truncate helper in seo-utils.ts |

## Security Considerations

- No user-generated content in meta tags (XSS risk)
- Validate all URLs are from trusted sources
- OG images hosted on same domain (prevent hotlinking)
- robots.txt doesn't leak sensitive paths

## Next Steps

→ **Phase 6**: Test & Polish (sample content, Lighthouse audit, responsive check, a11y)

**Dependencies**: Phase 6 requires Phase 5 complete (tests full SEO stack)
