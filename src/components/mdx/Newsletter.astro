---
import Button from '../ui/Button.astro';
import Input from '../ui/Input.astro';

interface Props {
  title?: string;
  description?: string;
  placeholder?: string;
  buttonText?: string;
  action?: string;
}

const {
  title = 'Subscribe to our newsletter',
  description = 'Get the latest updates delivered to your inbox.',
  placeholder = 'Enter your email',
  buttonText = 'Subscribe',
  action = '/api/newsletter'
} = Astro.props;
---

<div class="bg-neutral-50 dark:bg-neutral-900 rounded-xl p-8">
  <div class="max-w-md mx-auto text-center">
    <h3 class="text-2xl font-bold text-neutral-900 dark:text-white mb-2">
      {title}
    </h3>
    <p class="text-neutral-600 dark:text-neutral-400 mb-6">
      {description}
    </p>
    <form class="newsletter-form" action={action} method="POST">
      <div class="flex gap-2">
        <Input
          type="email"
          name="email"
          placeholder={placeholder}
          required
          class="flex-1"
        />
        <Button type="submit" variant="primary">
          {buttonText}
        </Button>
      </div>
      <div class="newsletter-message mt-3 text-sm hidden"></div>
    </form>
  </div>
</div>

<script is:inline>
  function initNewsletter() {
    document.querySelectorAll('.newsletter-form').forEach((form) => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageEl = form.querySelector('.newsletter-message');
        const submitBtn = form.querySelector('button[type="submit"]');
        const email = form.querySelector('input[type="email"]').value;

        if (!email || !email.includes('@')) {
          messageEl.textContent = 'Please enter a valid email address.';
          messageEl.className = 'newsletter-message mt-3 text-sm text-red-600 dark:text-red-400';
          messageEl.classList.remove('hidden');
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Subscribing...';

        try {
          const response = await fetch(form.action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });

          if (response.ok) {
            messageEl.textContent = 'Thanks for subscribing!';
            messageEl.className = 'newsletter-message mt-3 text-sm text-green-600 dark:text-green-400';
            form.reset();
          } else {
            throw new Error('Subscription failed');
          }
        } catch (error) {
          messageEl.textContent = 'Something went wrong. Please try again.';
          messageEl.className = 'newsletter-message mt-3 text-sm text-red-600 dark:text-red-400';
        } finally {
          messageEl.classList.remove('hidden');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Subscribe';
        }
      });
    });
  }

  initNewsletter();
  document.addEventListener('astro:page-load', initNewsletter);
</script>
