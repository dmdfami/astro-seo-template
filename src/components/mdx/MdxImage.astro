---
import { Image } from 'astro:assets';
import { cn } from '@lib/utils';

interface Props {
  src: string;
  alt: string;
  caption?: string;
  width?: number;
  height?: number;
  lazy?: boolean;
  lightbox?: boolean;
  class?: string;
}

const {
  src,
  alt,
  caption,
  width = 800,
  height = 600,
  lazy = true,
  lightbox = false,
  class: className
} = Astro.props;

const imageId = `img-${Math.random().toString(36).substr(2, 9)}`;
---

<figure class={cn('my-8', className)}>
  <Image
    id={imageId}
    src={src}
    alt={alt}
    width={width}
    height={height}
    loading={lazy ? 'lazy' : 'eager'}
    class={cn('rounded-lg w-full h-auto', lightbox && 'cursor-pointer')}
    data-lightbox={lightbox ? 'true' : 'false'}
  />
  {caption && (
    <figcaption class="mt-2 text-sm text-center text-neutral-600 dark:text-neutral-400">
      {caption}
    </figcaption>
  )}
</figure>

{lightbox && (
  <script is:inline>
    function initLightbox() {
      document.querySelectorAll('[data-lightbox="true"]').forEach((img) => {
        img.addEventListener('click', () => {
          const overlay = document.createElement('div');
          overlay.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4';

          const fullImg = document.createElement('img');
          fullImg.src = img.src;
          fullImg.alt = img.alt;
          fullImg.className = 'max-w-full max-h-full rounded-lg';

          const closeBtn = document.createElement('button');
          closeBtn.className = 'absolute top-4 right-4 text-white text-4xl hover:text-neutral-300';
          closeBtn.textContent = '\u00D7';

          overlay.appendChild(fullImg);
          overlay.appendChild(closeBtn);

          overlay.addEventListener('click', (e) => {
            if (e.target === overlay || e.target.tagName === 'BUTTON') {
              overlay.remove();
            }
          });

          document.body.appendChild(overlay);
        });
      });
    }

    initLightbox();
    document.addEventListener('astro:page-load', initLightbox);
  </script>
)}
